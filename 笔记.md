## 2020年学习Webpack笔记

### 1 初始化一个webpack项目

```
// 必须先全局安装
npm install -g webpack
npm install -g webpack-cli

// 项目下安装
npm init
npm install --save-dev webpack

// 打包
webpack
```

### 2 webpack打包

[视频 55:00 左右](https://www.bilibili.com/video/BV1a741197Hn?from=search&seid=9663403959295893105)

根据import引入等关键字，将依赖文件打包成一个文件。

#### 2.1 输出文件

输出文件的大体结构

```
(function(module) {
  var installedModules = {};
  function __webpack_require__(moduleId){
    // SOME CODE
  }
  // 。。。
  return __webpack_require__(0); // entry file
})([ /* modules array */])
```

上述结构中的核心方法：

```
function __webpack_require__(moduleId){
  // check if module is in cache
  if(installedModules[moduleId]){
    return installedModules[moduleId].exports;
  }
  // create a new module (and put into cache)
  var module = installedModules[moduleId] = {
    i: moduleId,
      l: false,
      exports: {}
  };
  // exe the module func
  modules[moduleId].call{
    module.exports,
      module,
      module.exports,
      __webpack_require__
  };
  // flag the module as loaded
  module.l = true;
  // return the exxports of the module
  return module.exports;
}
```

#### 2.2 webpack打包过程
1. 从入口文件开始，分析整个应用的依赖树
2. 将每个依赖模块包装起来，放到一个数组中等待调用
3. 实现模块加载的方法，并把它放到模块执行的环境中，确保模块间可以互相调用
4. 把执行入口文件的逻辑放在一个函数表达式中，并立即执行这个函数

### 3 实战

[视频 86:00 左右](https://www.bilibili.com/video/BV1a741197Hn?from=search&seid=9663403959295893105)

#### 3.1 语义化版本

1. ^version：中版本和小版本

    ^1.0.1 -> 1.x.x

2. ~version：小版本

    ^1.0.1 -> 1.0.x

3. version：特定版本

#### 3.2 初始化开发环境

1. webpack-dev-server
```
// 安装
npm install webpack-dev-server --save-dev

// 运行
webpack-dev-server
```

2. 遇到的问题：Error: Cannot find module 'webpack-cli/bin/config-yargs'
```
// 安装旧版本的 webpack-cli
npm install webpack-cli@3 --save-dev
```

#### 3.3 处理css

```
// 安装 样式 loader
npm install --save-dev css-loader style-loader
// 安装 样式预处理 loader
npm install --save-dev postcss-loader autoprefixer@7
// 处理 scss
npm install --save-dev sass-loader node-sass

// webpack-config.js 配置
devServer: {
  // 此路径下的打包文件可在浏览器中访问
  publicPath: '/dist'
},
module: {
  rules: [
    {
      test: /\.css$/,
      // 注意 loader 加载顺序和书写顺序是相反的
      use: [
        'style-loader',
        'css-loader',
        'postcss-loader'
      ]
    },
    {
      test: /\.(sass|scss)$/,
      // 注意 loader 加载顺序和书写顺序是相反的
      use: [
        'style-loader',
        'css-loader',
        'postcss-loader',
        'sass-loader'
      ]
    }
  ]
}

// 项目根目录新建 postcss.config.js
module.exports = {
  plugins: [
    require('autoprefixer')
  ]
}
```

1. 注意 loader 的顺序

2. devServer 不设置 publicPath 开发运行时会访问项目根目录

#### 3.4 处理图片

```
// 安装 loader
npm install --save-dev file-loader url-loader

// webpack-config.js 配置
module: {
  rules: [
    //处理文件
    {
      test: /\.(png|jpg|gif)$/i,
      use: [
        {
          loader: "url-loader",
          options: {
            outputPath: "static/img/",
            limit: 200 * 1024 //小于200kb用base64解析
          }
        }
      ]
    }
  ]
}
```

#### 3.5 处理html

```
// 安装 plugin
npm install --save-dev html-webpack-plugin copy-webpack-plugin@5 html-withimg-loader

// 将静态文件都放到public文件夹下

// webpack-config.js 配置
// 打包路径
output: {
  filename: 'static/js/main.js'
},
devServer: {
  contentBase: path.join(__dirname, "public")
},
module: {
  rules: [
    //处理在html中图片文件路径
    {
      test: /\.html$/,
      use: "html-withimg-loader"
    }
  ]
},
plugins: {
  new HtmlWebpackPlugin({
    template: "./public/index.html",
    filename: "index.html"
  }),
  new CopyWebpackPlugin([
    // 把 static 文件内的内容复制到 output.path 路径下的static文件内
    {
      from: path.join(__dirname, 'public/static'),
      to: "./static"
    }
  ])
}
```

1. 如果 html-withimg-loader 无效，可以试着将 file-loader 或者 url-loader 的 options.esModule 设为false
2. 如果要在 HtmlWebpackPlugin 设置 title 需要在 html 添加 <title><%= htmlWebpackPlugin.options.title %></title> 替换，并且会和 html-withimg-loader 冲突无效

#### 3.6 环境变量

```
npm install --save-dev webpack-merge

// 项目根目录新建 webpack.dev.js 和 webpack.prod.js
// 开发环境：development、生成环境：production
const webpack = require('webpack')
const { merge } = require('webpack-merge')
const base = require('./webpack.config.js')

module.exports = merge(base, {
  mode: 'development',
  plugins: [
    new webpack.DefinePlugin({
      NODE_ENV: "'development'",
      BASE_API: "'/dev'"
    })
  ]
})

// package.json
{
  "scripts": {
    "dev": "webpack-dev-server --config webpack.dev.js",
    "dev:prod": "webpack-dev-server --config webpack.prod.js",
    "build": "webpack --config webpack.prod.js"
  }
}
```

#### 3.7 babel 处理新语法

安装 babel-loader 处理 es6 等新语法

```
// 安装
npm install --save-dev  babel-loader@8.0.0-beta.0 @babel/core @babel/preset-env

// webpack.config.js
module: {
  rules: [
    {
      test: /\.(js|jsx)$/,
      use: 'babel-loader',
      exclude: path.resolve('node_modules'),
      include: path.resolve('src')
    },
  ]
}

// 根目录下新建 .babelrc
{
  "presets": [
    "@babel/preset-env"
  ],
  "plugins": []
}
```

#### 3.8 设置别名

```
// 方便模块的应用
resolve: {
  alias: {
    '@': path.resolve(SrcPath)
  }
},
```

#### 3.9 多入口文件

```
// webpack.config.js

//  入口文件
entry: {
  index: path.resolve(SrcPath, 'index.js'),
  readme: path.resolve(SrcPath, 'readme.js'),
},
// 打包路径
output: {
  // [name]：多入口文件名
  // [hash]：hash值
  filename: 'static/js/[name].[hash].js'
},

plugins: [
  new HtmlWebpackPlugin({
    template: path.resolve(__dirname, StaticPath, 'index.html'),
    filename: 'index.html',
    // 只引用某些入口文件，这些入口的值要在 entry 设置
    chunks: ['index']
  }),
  new HtmlWebpackPlugin({
    template: path.resolve(__dirname, StaticPath, 'index.html'),
    filename: 'readme.html',
    // 只引用某些入口文件，这些入口的值要在 entry 设置
    chunks: ['readme']
  }),
]
```

1. 注意 HtmlWebpackPlugin 的 chunks 数组要设置 entry 有的值












